name: release-sector-gateway

on:  # yamllint disable-line rule:truthy
    push:
        branches:
            - main
        tags:
            - "v*"

env:
    PANTS_CONFIG_FILES: pants.ci.toml

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  persist-credentials: false
            - name: Set version
              id: version
              run: |
                  VERSION="${GITHUB_REF_NAME#v}"
                  echo "VERSION=$VERSION" >> "$GITHUB_ENV"
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
            - name: Configure Pants caching to GitHub Actions Cache
              uses: actions/github-script@v6
              with:
                  script: |
                      core.exportVariable('PANTS_REMOTE_STORE_ADDRESS', process.env.ACTIONS_CACHE_URL);
                      core.exportVariable('PANTS_REMOTE_OAUTH_BEARER_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN);
            - name: Install Pants
              run: curl --proto '=https' --tlsv1.2 -fsSL https://static.pantsbuild.org/setup/get-pants.sh | bash
            - name: Pants Lint
              run: pants lint all
            - name: Pants Test
              run: pants test all
            - name: Build Gateway Appliance
              run: pants run scripts:build
            - name: Create GitHub Release
              id: create_release
              uses: actions/github-script@v7
              with:
                  script: |
                      const tag = context.ref.replace("refs/tags/", "")
                      const version = tag.replace(/^v/, "")

                      const release = await github.rest.repos.createRelease({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          tag_name: tag,
                          name: `Sector Gateway ${version}`,
                          body: `Sector Gateway router appliance ${version}`,
                          draft: false,
                          prerelease: false
                      })

                      return release.data.upload_url
            - name: Upload appliance
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require("fs")
                      const path = `scripts/sector-gateway-${process.env.VERSION}.tar.gz`

                      const uploadUrl = `${{ steps.create_release.outputs.result }}`
                        .replace("{?name,label}", "")

                      const data = fs.readFileSync(path)

                      await github.rest.repos.uploadReleaseAsset({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        release_id: context.payload.release?.id,
                        url: uploadUrl,
                        name: `sector-gateway-${process.env.VERSION}.tar.gz`,
                        data
                      })
            - name: Upload checksum
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require("fs")
                      const path = `scripts/sector-gateway-${process.env.VERSION}.tar.gz.sha256`

                      const uploadUrl = `${{ steps.create_release.outputs.result }}`
                        .replace("{?name,label}", "")

                      const data = fs.readFileSync(path)

                      await github.rest.repos.uploadReleaseAsset({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        release_id: context.payload.release?.id,
                        url: uploadUrl,
                        name: `sector-gateway-${process.env.VERSION}.tar.gz`,
                        data
                      })
